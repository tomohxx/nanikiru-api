# Nanikiru API

一人麻雀における和了確率や得点期待値を計算するツール(API).

## 使用方法

コンテナを起動する.

```shell
$ docker-compose up -d --build
```

API にリクエストを送信する. 打牌候補ごと巡目ごとの和了確率または得点期待値の配列が返される.  
実行例:

```shell
$ ./request1.sh | jq
Note: Unnecessary use of -X or --request, POST is already inferred.
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0*   Trying 127.0.0.1:18000...
* TCP_NODELAY set
* Connected to localhost (127.0.0.1) port 18000 (#0)
> POST /prob/t1 HTTP/1.1
> Host: localhost:18000
> User-Agent: curl/7.68.0
> Accept: */*
> Content-Type: application/json
> Content-Length: 135
>
} [135 bytes data]
* upload completely sent off: 135 out of 135 bytes
* Mark bundle as not supporting multiuse
< HTTP/1.1 200 OK
< Server: nginx/1.20.2
< Date: Tue, 21 Mar 2023 11:30:39 GMT
< Content-Type: application/json
< Content-Length: 718
< Connection: keep-alive
<
{ [718 bytes data]
100   853  100   718  100   135   116k  22500 --:--:-- --:--:-- --:--:--  166k
* Connection #0 to host localhost left intact
{
  "searched": 3,
  "stats": [
    {
      "prob": [
        0,
        2579.7118196220963,
        2464.744149693427,
        2345.9120202713575,
        2223.08553355779,
        2096.130425442085,
        1964.9079187342559,
        1829.274571464819,
        1689.0821200854853,
        1544.1773173992829,
        1394.401765042956,
        1239.5917403385174,
        1079.5780173246862,
        914.1856817725746,
        743.2339399834175,
        566.5359211593307,
        383.8984731310728,
        195.1219512195122,
        0
      ],
      "tile": "1m"
    },
    {
      "prob": [
        0,
        2579.7118196220963,
        2464.744149693427,
        2345.9120202713575,
        2223.08553355779,
        2096.130425442085,
        1964.9079187342559,
        1829.274571464819,
        1689.0821200854853,
        1544.1773173992829,
        1394.401765042956,
        1239.5917403385174,
        1079.5780173246862,
        914.1856817725746,
        743.2339399834175,
        566.5359211593307,
        383.8984731310728,
        195.1219512195122,
        0
      ],
      "tile": "4m"
    }
  ]
}
```

## エンドポイント

| URI         | 説明                                       |
| ----------- | ------------------------------------------ |
| `/prob/t1/` | 手替わりなし・シャンテン戻しなし(タイプ 1) |
| `/prob/t2/` | 手替わりあり・シャンテン戻しあり(タイプ 2) |

### 計算タイプ

手牌方向と巡目方向からなるグラフの辺の緩和順に対応して 2 つの計算タイプが存在する.

- タイプ 1
  - 手牌方向: 外側, 巡目方向: 内側
  - 高速
  - 手替わり・シャンテン戻しを考慮できない
- タイプ 2
  - 手牌方向: 内側, 巡目方向: 外側
  - 低速
  - 手替わり・シャンテン戻しを考慮できる

## リクエストボディ

[schema.json](app/src/schema.json)を参照する.

| プロパティ  | 型     | 説明                                                                               |
| ----------- | ------ | ---------------------------------------------------------------------------------- |
| `hand`      | 文字列 | 手牌(mpsz 表記, 赤ドラは 0 で表す, 14 枚)                                          |
| `dora`      | 文字列 | ドラ表示牌(mpsz 表記, 赤ドラは 0 で表す, 0 枚から 4 枚まで)                        |
| `jikaze`    | 整数   | 自風(東南西北をそれぞれ 0 から 3 で表す)                                           |
| `bakaze`    | 整数   | 場風(東南西北をそれぞれ 0 から 3 で表す)                                           |
| `mode`      | 整数   | シャンテン数を計算するモード(一般形: 1, 七対子: 2, 国士無双: 4 としたビット論理和) |
| `extra`     | 整数   | 手替わり回数(タイプ 1 では無視される)                                              |
| `calcScore` | 論理値 | true: 得点期待値を計算する, false: 和了確率を計算する                              |
| `useRed`    | 論理値 | true: 赤ドラを考慮する, false: 赤ドラを考慮しない                                  |

## レスポンスボディ

| プロパティ | 型   | 説明                                                            |
| ---------- | ---- | --------------------------------------------------------------- |
| `searched` | 整数 | 探索した手牌の数                                                |
| `stats`    | 配列 | 打牌候補ごと巡目ごとの和了確率または得点期待値(巡目は 0 始まり) |

## 備考

- 立直は考慮しない.
- 得点期待値を計算する場合は必ず門前自摸をつける.
- 一般形, 七対子, 国士無双の 2 つ以上の組み合わせの天秤が可能.

## 参考

- https://tomohxx.github.io/mahjong-algorithm-book/probability/ (アルゴリズムの解説)
- https://github.com/tomohxx/mahjong-win-prob

## ライセンス

GNU General Public License v3.0.
